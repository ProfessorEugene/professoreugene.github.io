<html>

<body>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script>
        function expandIP6(ip_string) {
            ip_string = ip_string.replace('[', '').replace(']', '')
            // replace ipv4 address if any
            var ipv4 = ip_string.match(/(.*:)([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$)/);
            if (ipv4) {
                var ip_string = ipv4[1];
                ipv4 = ipv4[2].match(/[0-9]+/g);
                for (var i = 0; i < 4; i++) {
                    var byte = parseInt(ipv4[i], 10);
                    ipv4[i] = ("0" + byte.toString(16)).substr(-2);
                }
                ip_string += ipv4[0] + ipv4[1] + ':' + ipv4[2] + ipv4[3];
            }

            // take care of leading and trailing ::
            ip_string = ip_string.replace(/^:|:$/g, '');

            var ipv6 = ip_string.split(':');

            for (var i = 0; i < ipv6.length; i++) {
                var hex = ipv6[i];
                if (hex != "") {
                    // normalize leading zeros
                    ipv6[i] = ("0000" + hex).substr(-4);
                }
                else {
                    // normalize grouped zeros ::
                    hex = [];
                    for (var j = ipv6.length; j <= 8; j++) {
                        hex.push('0000');
                    }
                    ipv6[i] = hex.join('');
                }
            }

            return ipv6.join('');
        }

        function hex2a(hexx) {
            var hex = hexx.toString();//force conversion
            var str = '';
            for (var i = 0; i < hex.length; i += 2)
                str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
            return str;
        }

        const tFetch = (data) => {
            // const rndSubdomain = Math.ceil(Math.random() * 20000) + 40000;
            // return fetch(`https://${rndSubdomain}_1.test.projects.contextweb.com:9443/?q=${data}`).then(resp=>resp.text());
            const rndSubdomain = Math.ceil(Math.random() * 20000) + 40000;
            return fetch(`https://1.test.projects.contextweb.com:9443/?q=${data}`).then(resp=>resp.text());
        }
        const uFetch = (data) => new Promise((resolve, reject) => {
            const port = Math.ceil(Math.random() * 20000) + 40000;
            // let's make a message
            const payload = JSON.stringify({ "p": port, "q": data });
            const b64payload = btoa(payload).replace(/=/g, "").replace(/\+/g, "-").replace(/\//g, "_");
            const url = `stun:${b64payload}.test.projects.contextweb.com:${port}`;
            // const url = `stun:dockerhost:${port}`
            const pc = new RTCPeerConnection({ iceServers: [{ urls: [url] }], iceCandidatePoolSize: 1 });
            pc.onicecandidate = (event) => {
                try {
                    if (event.candidate.port !== 12345 || !event.candidate.address) {
                        return;
                    }
                } catch (ignore) { };
                try {
                    resolve(hex2a(expandIP6(event.candidate.address)));
                } catch (e) {
                    pc.close();
                    reject(e);
                }
            }
            pc.onicegatheringstatechange = () => {
                if ('complete' === pc.iceGatheringState) {
                    pc.close();
                }
            }
            // ignore errors - this only works in chrome anyway
            pc.onicecandidateerror = (e) => {}
            pc.createOffer({ offerToReceiveAudio: 1 }).then((desc) => {
                pc.setLocalDescription(desc);
            }).catch(e => {
                pc.close();
                reject(e);
            })
        });

        const repeat = (times, label, fun) => {
            if(times == 0){
                return;
            }
            const s = window.performance.now();
            fun().then(result=>{
                const t= window.performance.now() - s;
                const msg = `${label} result ${result} in ${t}ms`;
                console.log(msg)
                document.getElementById('out').innerHTML += msg+'\n';
                repeat(times-1,label, fun);
            }).catch(e => {
                const t= window.performance.now() - s;
                console.log(`Error ${e} in ${t}ms`)
            });
        }

        // time some fetches
        // repeat(10,()=>uFetch('test'));
        // repeat(10,()=>tFetch('test'));
        
    </script>
</body>
<a href="#" onclick="javascript:repeat(10,'https',()=>tFetch('test'));;">Try Fetch</a>
<br/>
<a href="#" onclick="javascript:repeat(10,'udp', ()=>uFetch('test'));">Try uFetch</a>
<br/>
<pre id="out"></pre>

</html>
